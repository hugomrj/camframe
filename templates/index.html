<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Videos</title>

    <!-- Semantic UI -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css">

    <!-- Estilos propios -->
    <link rel="stylesheet" href="/static/style.css">
</head>

<body class="page-bg">

    <div class="ui container" style="max-width: 700px; padding-top: 30px;">

        <h1 class="ui header">Videos</h1>

        {% if videos %}
        <div class="ui divided items">

            {% for v in videos %}
            <div class="item">

                <div class="content">


                    <!-- T√≠tulo + Estado -->
                    <div class="header">
                        {{ v.nombre }}
                        
                        {% if v.is_streaming %}
                            <span class="ui green label" style="margin-left: 10px;">Stream Activo</span>
                            
                            {% if v.is_yolo_active %}
                                <span class="ui blue label" style="margin-left: 5px;">
                                    <i class="robot icon"></i> YOLO Activo
                                </span>
                            {% else %}
                                <span class="ui grey label" style="margin-left: 5px;">
                                    <i class="robot icon"></i> YOLO Inactivo
                                </span>
                            {% endif %}
                            
                        {% else %}
                            <span class="ui grey label" style="margin-left: 10px;">Inactivo</span>
                        {% endif %}
                    </div>



                    <!-- Link archivo -->
                    <div class="description" style="margin-top: 8px;">
                        <a href="{{ v.ruta }}" target="_blank" class="ui basic blue label">
                            Ver archivo
                        </a>
                    </div>


<!-- Botones -->
<div class="extra" style="margin-top: 10px;">
    {% if v.is_streaming %}
        <form action="/stream/stop/{{ v.id }}" method="get" style="display: inline;">
            <button class="ui red button">Detener</button>
        </form>
        
        <!-- Bot√≥n para INICIAR YOLO (cuando el stream normal est√° activo pero YOLO no) -->
        {% if not v.is_yolo_active %}

            <form action="/yolo/start/{{ v.id }}" method="post" style="display: inline;" 
                onsubmit="startYolo(event, {{ v.id }})">
                <button class="ui orange button" type="submit">
                    <i class="rocket icon"></i>
                    Iniciar YOLO
                </button>
            </form>
            
        {% endif %}
        
        <!-- Bot√≥n para VER YOLO (solo cuando YOLO est√° activo) -->
        {% if v.is_yolo_active %}
            <a href="/yolo/player/{{ v.id }}" class="ui green button" target="_blank">
                <i class="eye icon"></i>
                Ver con YOLO
            </a>
        {% endif %}
        
    {% else %}
        <form action="/stream/start/{{ v.id }}" method="get" style="display: inline;">
            <button class="ui primary button">Iniciar Stream</button>
        </form>
    {% endif %}
</div>





                    <!-- RTSP -->
                    <div class="meta" style="margin-top: 6px;">
                        <span class="ui tiny grey text">
                            rtsp://localhost:8554/video{{ v.id }}
                        </span>
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <p class="ui center aligned grey text" style="margin-top: 20px;">
            No hay videos cargados.
        </p>
        {% endif %}

        <div class="ui center aligned segment basic">
            <a href="/upload" class="ui basic blue button">Subir nuevo video</a>
        </div>



    <!-- üÜï Script para iniciar YOLO -->
<script>
function startYolo(event, videoId) {
    event.preventDefault(); // Evitar env√≠o normal del formulario
    
    console.log('Iniciando YOLO para video:', videoId);
    
    // Mostrar mensaje de carga
    const button = event.target.querySelector('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="spinner loading icon"></i> Iniciando...';
    button.disabled = true;
    
    fetch(`/yolo/start/${videoId}`, { method: 'POST' })
        .then(response => {
            console.log('Respuesta recibida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
            
            if (data.status) {
                // ‚úÖ YOLO iniciado - mostrar mensaje de √©xito
                button.innerHTML = '<i class="check icon"></i> ¬°Iniciado!';
                button.classList.remove('orange');
                button.classList.add('green');
                
                console.log('YOLO iniciado, recargando en 3 segundos...');
                
                // Recargar p√°gina despu√©s de 3 segundos (m√°s tiempo)
                setTimeout(() => {
                    console.log('Recargando p√°gina...');
                    window.location.href = '/'; // Forzar recarga
                }, 3000);
            } else {
                // ‚ùå Error
                console.error('Error al iniciar YOLO:', data.error);
                button.innerHTML = '<i class="exclamation icon"></i> Error';
                button.classList.remove('orange');
                button.classList.add('red');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('red');
                    button.classList.add('orange');
                    button.disabled = false;
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error de red:', error);
            button.innerHTML = '<i class="exclamation icon"></i> Error de red';
            button.classList.remove('orange');
            button.classList.add('red');
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('red');
                button.classList.add('orange');
                button.disabled = false;
            }, 3000);
        });
}
</script>
</body>
</html>
